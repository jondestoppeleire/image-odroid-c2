# this is a sh file, not bash

# turn off power savings, set the background to black
/usr/bin/xset -dpms
/usr/bin/xset s off
/usr/bin/xsetroot -solid white

chromium_platform="-use-gl=egl --ignore-gpu-blacklist --disable-accelerated-2d-canvas --enable-gpu-rasterization --enable-gpu-memory-buffer-video-frames --enable-zero-copy-dxgi-video --video-threads=4"
cache_dir=/home/eatsa/chromium
chromium_opts="--allow-running-insecure-content --no-first-run --user-data-dir=$cache_dir"

if mount -r -L EATSACONF /mnt; then
    [ -r /mnt/config.txt ] && . /mnt/config.txt
    umount /mnt
fi

# force the output framerate to 30fps, but fail gracefully if not supported
/usr/bin/xrandr --refresh 30 || true

# set rotation / mirroring params based on display connection
output=$(/usr/bin/xrandr | grep " connected " | cut -d' ' -f1)
if [ -n "$WISE_ROTATE" ]; then
    /usr/bin/xrandr --output "$output" --rotate "$WISE_ROTATE"
else
    case "$output" in
        DP1|DisplayPort-0) /usr/bin/xrandr --output "$output" --rotate left ;; # brand/menu/status
        HDMI1|HDMI-0) /usr/bin/xrandr --output "$output" --rotate inverted ;; # cubby
    esac
fi

# run a minimal windows manager to facilitate full-screen
/usr/bin/openbox-session &

# allow full-scree exit if WISE_OPTS is set
[ -n "$DEBUG" ] && WISE_OPTS=1
if [ -n "$WISE_OPTS" ]; then
    chromium_mode="--start-fullscreen"
else
    chromium_mode="--kiosk"
fi

# allow timezone override for chromium only
if [ -n "$WISE_TZ" ]; then
    export TZ=$WISE_TZ
fi

# this loop also prevents any further xsession scripts from running
rm -rf $cache_dir
nice -n -20 /usr/bin/chromium-browser \
    "$chromium_opts" \
    "$chromium_mode" \
    "$chromium_platform" \
    "$WISE_OPTS" \
    "$WISE_URL"
