# Use a full VM since we'll be using docker
#
# https://docs.travis-ci.com/user/reference/overview/#virtualisation-environment-vs-operating-system
# https://docs.travis-ci.com/user/docker/

sudo: required
dist: trusty

language: c

addons:
  apt:
    packages:
      - awscli

services:
  - docker

# Note that `build-setup.sh` should be run before `docker build`.
# Without the packages installed on the host, specifically binfmt_support,
# the docker image will not be built correctly.  With the package installed,
# the docker image build will only produce warnings, but the end image will
# be functional.
install:
  - shellcheck mk_build_env.sh run_build_env.sh build-scripts/build-setup.sh build.sh
  - build-scripts/build-setup.sh
  - ./mk_build_env.sh ubuntu-xenial

script:
- ./run_build_env.sh ubuntu-xenial

deploy:
  skip_cleanup: true
  provider: s3
  access_key_id: $AWS_ACCESS_KEY_ID
  secret_access_key: $AWS_SECRET_ACCESS_KEY
  bucket: eatsa-packages
  local-dir: pkg
  upload-dir: image-odroid-c2
  acl: private
  on:
    all_branches: true
    condition: $AWS_SECRET_ACCESS_KEY != ""
